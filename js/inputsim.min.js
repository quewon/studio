class StrippedEvent{constructor(t){t=t||{},this.type=t.type,this.key=t.key,this.code=t.code}}class SimulationState{constructor(t){if(t=t||{},this.textContent=t.textContent||"",this.selectionStart=t.selectionStart||0,this.selectionEnd=t.selectionEnd||0,this.selectionDirection=t.selectionDirection||0,this.shiftKey=t.shiftKey||!1,this.metaKey=t.metaKey||!1,this.clearedText=[],t.clearedText)for(let e of t.clearedText)this.clearedText.push(e)}}class InputEvent{constructor(t,e,n){this.strippedEvent=new StrippedEvent(t),this.bakedState=e?new SimulationState(e):null,this.timeStamp=n||0}}class Simulator{constructor(){this.domElement=createElement("div",{parent:document.body,className:"output"}),this.caretElement=createElement("div",{parent:this.domElement,className:"caret"}),this.lastPrintedState=null}simulateEvent(t,e){let n=e.strippedEvent,i=e.timeStamp;var s,a=new SimulationState(t);let l=t.textContent,r=t.selectionStart,o=t.selectionEnd;if("keydown"==n.type){if("Backspace"==n.key)r!=o?(a.selectionEnd=a.selectionStart,a.textContent=l.slice(0,r)+l.slice(o)):(a.selectionStart=a.selectionEnd=Math.max(r-1,0),a.textContent=l.slice(0,a.selectionStart)+l.slice(o));else{switch(n.key){case"Enter":settings.clearWithEnter?(a.clearedText.push(a.textContent),a.clearedText.push(i),a.textContent="",a.selectionStart=a.selectionEnd=0):s="\r\n";break;case"Shift":a.shiftKey=!0;break;case"Meta":a.metaKey=!0;break;case"Alt":case"Control":case"Escape":case"ArrowUp":case"ArrowDown":break;case"ArrowLeft":t.shiftKey?r==o?r>0&&(a.selectionDirection=-1,a.selectionStart--):0!=t.selectionDirection&&(-1==t.selectionDirection?a.selectionStart=Math.max(r-1,0):1==t.selectionDirection&&a.selectionEnd--):r!=o?a.selectionEnd=r:a.selectionStart=a.selectionEnd=Math.max(r-1,0);break;case"ArrowRight":t.shiftKey?r==o?a.selectionStart<l.length&&(a.selectionDirection=1,a.selectionEnd++):0!=t.selectionDirection&&(-1==t.selectionDirection?a.selectionStart++:1==t.selectionDirection&&(a.selectionEnd=Math.min(o+1,l.length))):r!=o?a.selectionStart=o:a.selectionStart=a.selectionEnd=Math.min(r+1,l.length);break;default:t.shiftKey?s=n.key.toUpperCase():t.metaKey?"a"===n.key&&(a.selectionStart=0,a.selectionEnd=l.length,a.selectionDirection=-1):s=n.key}s&&(a.textContent=l.slice(0,r)+s+l.slice(o),a.selectionEnd=a.selectionStart=r+s.length)}}else if("keyup"==n.type)switch(n.key){case"Shift":a.shiftKey=!1;break;case"Meta":a.metaKey=!1}if(settings.assembleHangul){var c=Hangul.disassemble(a.textContent),m=a.textContent.length;a.textContent=Hangul.assemble(c);var h=a.textContent.length-m;0!=h&&(a.selectionStart+=h,a.selectionEnd+=h)}return a}getStateAtTimeStamp(t,e){var n=new SimulationState;for(let i of t){if(i.timeStamp>e)break;n=settings.useBakedStates&&i.bakedState?i.bakedState:this.simulateEvent(n,i)}return n}clearState(){for(this.domElement.textContent="";this.caretElement.lastChild;)this.caretElement.lastChild.remove()}printState(t){if(this.lastPrintedState=t,!t){this.clearState();return}this.domElement.textContent=t.textContent;var e=t.selectionStart,n=t.selectionEnd;e==n&&n<=t.textContent.length-1&&n++;var i=document.createRange();for(i.setStart(this.domElement.firstChild||this.domElement,e),i.setEnd(this.domElement.firstChild||this.domElement,n);this.caretElement.lastChild;)this.caretElement.lastChild.remove();return this.caretElement.appendChild(i.extractContents()),i.insertNode(this.caretElement),t}printStateAtTimestamp(t,e){this.printState(this.getStateAtTimeStamp(t,e))}printFinalState(t){events&&0!=events.length?this.printState(this.getStateAtTimeStamp(t,events[events.length-1].timeStampStamp)):this.clearState()}getBakedEvents(t){var e=[],n=new SimulationState,i=settings.useBakedStates;for(let s of(settings.useBakedStates=!0,t))n=this.simulateEvent(n,s),e.push(new InputEvent(s.strippedEvent,new SimulationState(n),s.timeStamp));return settings.useBakedStates=i,e}remove(){this.caretElement.remove(),this.domElement.remove()}}function createClearedTextLog(t){return t.split("\r\n")}class Conversation{constructor(){this.domElement=createElement("div",{parent:document.body,className:"conversation"})}clear(){for(;this.domElement.lastElementChild;)this.domElement.lastElementChild.remove()}getBaked(t){var e=[],n=[];for(let i of t)for(let s of i)n.push(s.timeStamp);var a=[];for(let l of n)-1==a.indexOf(l)&&a.push(l);a.sort((t,e)=>t-e);var r=settings.useBakedStates;for(let o of(settings.useBakedStates=!0,a)){var c=[];for(let m of t)c.push(Simulator.prototype.getStateAtTimeStamp(m,o));var h=this.getBakedFrame(c);if(e.length>0){let d=e[e.length-1];d.length!=h.length&&e.push(h)}else e.push(h)}return settings.useBakedStates=r,e}getBakedFrame(t){var e=[];for(let n=0;n<t.length;n++){let i=t[n];if(!i)continue;let s="dialogue c"+n;for(let a=0;a<i.clearedText.length;a+=2)e.push({textContent:i.clearedText[a],className:s,timeStamp:i.clearedText[a+1]})}return e.sort((t,e)=>t.timeStamp-e.timeStamp),e}print(t){this.clear();var e=this.getBakedFrame(t);for(let n of e)createElement("div",{parent:this.domElement,className:n.className,textContent:n.textContent})}}
